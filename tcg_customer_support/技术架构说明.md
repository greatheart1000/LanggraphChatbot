# TCG 智能客服系统 - 技术架构说明

## 🛠️ 核心技术栈

### 1. **LangGraph** - 图状态机框架
- **作用**: 核心编排框架，管理整个客服流程
- **特性**: 
  - 状态图（StateGraph）管理
  - 节点（Nodes）和边（Edges）定义
  - 条件路由（Conditional Edges）
  - 状态持久化（Checkpointing）

### 2. **LangChain** - LLM 应用框架
- **作用**: 提供 LLM 调用和提示词管理
- **组件**:
  - `ChatOpenAI`: OpenAI API 封装
  - `ChatPromptTemplate`: 提示词模板
  - `with_structured_output`: 结构化输出

### 3. **FastAPI** - Web 框架
- **作用**: 提供 RESTful API 服务
- **特性**:
  - 异步处理
  - 自动 API 文档（Swagger）
  - 流式响应（SSE）

### 4. **OpenAI API** - 大语言模型
- **模型**: gpt-4.1-mini（可配置）
- **用途**: 
  - 场景分类
  - 回复生成
  - 自然语言理解

## 📊 系统能力

### ✅ 已实现的能力

#### 1. **多轮对话（Multi-turn Conversation）**
- **实现方式**: 使用 `thread_id` 管理会话
- **技术**: LangGraph Checkpointing
- **存储**: MemorySaver（内存，可升级为数据库）

```python
# 使用相同的 thread_id 可以继续对话
config = {"configurable": {"thread_id": "session-123"}}
result1 = graph.invoke(state1, config)  # 第一轮
result2 = graph.invoke(state2, config)  # 第二轮（自动包含历史）
```

**状态字段**:
- `messages`: 使用 `add_messages` reducer，自动累积对话历史
- `history`: 处理历史记录

#### 2. **短期记忆（Short-term Memory）**
- **实现方式**: 
  - LangGraph 的 `messages` 字段自动累积
  - 使用 `Annotated[List[AnyMessage], add_messages]` reducer
- **范围**: 当前会话内的所有消息
- **存储**: 内存（通过 MemorySaver）

#### 3. **长期记忆（Long-term Memory）**
- **当前状态**: ⚠️ **未完全实现**
- **潜在实现**:
  - 使用数据库 Checkpoint（PostgreSQL/SQLite）
  - 会话历史持久化
  - 用户偏好记忆

**可升级方案**:
```python
from langgraph.checkpoint.postgres import PostgresSaver

checkpointer = PostgresSaver.from_conn_string("postgresql://...")
graph = builder.compile(checkpointer=checkpointer)
```

#### 4. **智能场景分类**
- **技术**: LLM + 结构化输出（Pydantic）
- **能力**:
  - 识别 13 大类场景
  - 识别 70+ 子类场景
  - 置信度评分
  - 自动降级处理

#### 5. **知识库检索（RAG）**
- **实现**: SOP 文档检索
- **技术**: 
  - 文件系统检索
  - 基于类别和子类的匹配
  - 内容片段提取
- **数据源**: `智能客服系统/sop_data_global_en/` 目录下的 Markdown 文件

#### 6. **流式处理（Streaming）**
- **实现**: LangGraph 的 `stream()` 方法
- **模式**: 
  - `values`: 完整状态流
  - `updates`: 增量更新流
  - `messages`: 仅消息流
- **API**: 支持 Server-Sent Events (SSE)

#### 7. **条件路由（Conditional Routing）**
- **实现**: `add_conditional_edges`
- **能力**:
  - 根据分类结果路由
  - 根据置信度路由
  - 根据场景类型路由

#### 8. **降级处理（Fallback）**
- **场景**: 
  - 无法分类的查询
  - 闲聊、问候
  - 其他未分类问题
- **智能识别**: 自动检测问候、告别、闲聊

#### 9. **会话管理**
- **API 支持**: 
  - 创建会话（自动生成 thread_id）
  - 获取会话信息
  - 删除会话
- **存储**: 内存字典（可升级为 Redis/数据库）

### ⚠️ 未实现但可扩展的能力

#### 1. **长期记忆优化**
- **当前**: 仅内存存储，重启后丢失
- **可扩展**: 
  - 数据库持久化
  - 用户偏好记忆
  - 历史对话摘要

#### 2. **向量检索（Vector Search）**
- **当前**: 基于文件名的简单匹配
- **可扩展**: 
  - 使用 Embeddings 向量化 SOP
  - 语义相似度检索
  - 更精准的知识匹配

#### 3. **工具调用（Tool Calling）**
- **当前**: 未实现
- **可扩展**: 
  - 订单查询工具
  - 支付状态工具
  - 账户信息工具

#### 4. **人机交互（Human-in-the-Loop）**
- **当前**: 未实现
- **可扩展**: 
  - 中断等待人工介入
  - 人工审核回复
  - 人工确认操作

#### 5. **对话摘要（Conversation Summarization）**
- **当前**: 未实现
- **可扩展**: 
  - 长对话自动摘要
  - 关键信息提取
  - 上下文压缩

#### 6. **情感分析（Sentiment Analysis）**
- **当前**: 未实现
- **可扩展**: 
  - 检测用户情绪
  - 调整回复语气
  - 紧急问题优先处理

## 🔄 处理流程

```
用户查询
  ↓
[分类场景] → LLM 结构化输出分类
  ├─→ 成功分类 → [获取流程] → [处理场景] → 返回回复
  └─→ 失败/闲聊 → [降级处理] → 返回通用回复
```

## 📈 性能特性

### 当前实现
- ✅ 异步处理（FastAPI）
- ✅ 流式输出
- ✅ 状态持久化（内存）
- ✅ 错误处理和降级

### 可优化点
- ⚠️ 缓存机制（常见查询）
- ⚠️ 并发处理优化
- ⚠️ 数据库持久化
- ⚠️ 向量检索优化

## 🔐 安全特性

- ✅ API 密钥管理（环境变量）
- ✅ 会话隔离（thread_id）
- ⚠️ 可扩展：API 认证、限流、日志审计

## 📊 数据流

```
用户查询
  ↓
状态管理 (CustomerSupportState)
  ├─ messages: 对话历史（自动累积）
  ├─ context: 上下文信息
  ├─ category/subcategory: 分类结果
  └─ history: 处理历史
  ↓
Checkpoint 保存（MemorySaver）
  ↓
下次调用时自动恢复
```

## 🎯 总结

### 已实现
- ✅ 多轮对话（基于 thread_id）
- ✅ 短期记忆（当前会话）
- ✅ 智能分类
- ✅ 知识检索（SOP）
- ✅ 流式处理
- ✅ 条件路由
- ✅ 降级处理

### 部分实现
- ⚠️ 长期记忆（仅内存，可升级数据库）
- ⚠️ 知识检索（简单匹配，可升级向量检索）

### 未实现但可扩展
- ❌ 工具调用
- ❌ 人机交互
- ❌ 对话摘要
- ❌ 情感分析

## 🚀 升级建议

1. **长期记忆**: 使用 PostgreSQL/SQLite Checkpoint
2. **向量检索**: 集成 Chroma/Pinecone
3. **工具调用**: 添加业务 API 工具
4. **缓存**: 使用 Redis 缓存常见查询
5. **监控**: 添加 LangSmith 追踪

